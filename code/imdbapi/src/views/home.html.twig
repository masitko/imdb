{% extends "layout.html.twig" %}

{% block content %}
    <main>
        <div id="home-search">
            <h1 id="home-logo">
                <img src="img/movie-rex.png" alt="MovieRex" />
            </h1>
            <input class="title-box" onfocus="this.placeholder = ''" onblur="this.placeholder = 'Tell me a movie you like'" type="text" placeholder="Tell me a movie you like"></input>
            <ul class="results-container"></ul>
            {#            <a class="action-button green">suggest films</a>#}
            {#            <input id="type-selector" type="range" min="0" max="2" step="1" value="0" />#}
            <div class="tv-checkbox">
                <label class="tv" for="tv">include TV?</label>
                <input  id= "tv" type="checkbox" name="tv" value="tv">
            </div>
            <img id="rex-fill" class="" src="img/movie-rex-fill.png" alt="MovieRex" />
        </div>

        <ul class="suggestions-container"></ul>
        <div id="suggestive-slider">
            {#  <div>
                  <div class="suggestion" style="background:url('/img/jpark.jpg')">
                      <h4>Movie title here</h4>
                      <h5 class="imdb">8.1</h5>
                  </div>
              </div>
              <div>
                  <div class="suggestion">
                      
                      <img src="/img/jpark.jpg" />
                      <h4>Movie title here</h4>
                      <h5 class="imdb">9.9</h5>
                  </div>
              </div>
              <div>
                  <div class="suggestion">
                      
                      <img src="/img/jpark.jpg" />
                      <h4>Movie title here</h4>
                      <h5 class="imdb">9.9</h5>
                  </div>
              </div>#}
        </div>
    </main>
    <div id="overlay" class="transition"></div>



{% endblock content %}
{% block postscripts %}
    <script type="text/javascript" src="/js/slick.min.js"></script>
    <script>

        $(function () {
            //for browsers that don't support pointer events none
            $('#home-logo').click(function () {
                setTimeout(function () {
                    $('.title-box').focus();
                }, 0.01);
            });

            // cue fuzzy seatch
            $('.title-box').keyup(function () {
                if (this.value.length > 0) {
                    getData(this.value.replace(/ /g, '_').toLowerCase());
                }
                else {
                    $('.results-container').html('');
                }
            });

            //fade in and animate logo
            $('body').addClass('loaded');
            var homeSearch = $('#home-search');
            TweenMax.from(homeSearch, 2.5, {ease: Bounce.easeOut, top: -600});
        {#            $('<img/>').attr('src', '/img/curtains.jpg').load(function () {#}
        {#            $(this).remove(); // prevent memory leaks as @benweet suggested#}
        {#            });#}



            });

            //fuzzy search
            function getData(title) {
                var url = "{{ url('_imdb_api_suggests') }}";
                return $.ajax({
                    url: url + '/' + title
                }).success(function (data) {
                    if (data.d !== undefined) {
                        displayTitles(data.d);
                    }
                });
            }

            //fuzzy search results
            function displayTitles(titles) {
                $('.results-container').html('');
                $.each(titles, function (index, title) {
                    var check1 = "movie";
                    var check2 = "feature";
                    var check3 = "TV series";
                    var image = '/img/jpark.jpg';

                    if (title.i !== undefined) {
                        var ia = title.i[0].split('.');
                        var type = ia.pop();
                        ia.pop();
                        ia.push('_V1');
                        ia.push('_UX40_CR0,0,40,54_');
                        ia.push(type);
                        image = ia.join('.');
                    }
                    if ($('#tv').is(':checked')) {
                        if (title.q && (title.q.indexOf(check3) !== -1)) {
                            var tvId = ' TV';
                        } else {
                            var tvId = '';
                        }
                        if (title.q && (title.q.indexOf(check1) !== -1 || title.q.indexOf(check2) !== -1 || title.q.indexOf(check3) !== -1)) {
                            var html = '<li><div class="row title-container" data-id="' + title.id + '" data-title="' + title.l + '"><div class="columns small-2 fuzzy-image"><img src="' + image + '" alt="' + title.l + '"/></div><div class="columns small-10 fuzzy-title"><strong>' + title.l + '</strong> (' + title.y + ')' + tvId + '</div></div></li>';
                            $('.results-container').append(html);
                        }
                    }
                    else {
                        if (title.q && (title.q.indexOf(check1) !== -1 || title.q.indexOf(check2) !== -1)) {
                            var html = '<li><div class="row title-container" data-id="' + title.id + '" data-title="' + title.l + '"><div class="columns small-2 fuzzy-image"><img src="' + image + '" alt="' + title.l + '"/></div><div class="columns small-10 fuzzy-title"><strong>' + title.l + '</strong> (' + title.y + ')</div></div></li>';
                            $('.results-container').append(html);
                        }
                    }
                });

                //Move title into input field, toggle searching class, start search
                $('.title-container').click(function (e) {
                    $('.title-box').val($(this).data('title'));
                    getTitleData($(this).data('id')); //find recommendations
                    $('body').toggleClass('searching');
                });
            }

            //Search for recommendations
            function getTitleData(id) {
        {#                console.log(id);#}
                var url = "{{ url('_imdb_api_title') }}";
                return $.ajax({
                    url: url + '/' + id
                }).success(function (data) {
                    if (data !== undefined) {
                        displaySuggestions(data);
                    }
                });
            }

            //display recommendations
            function displaySuggestions(titles) {

                //empty the fuzzy search
                $('.results-container').html('');

                //destroy and empty the slider if it exists
                if ($('#suggestive-slider').hasClass('slick-initialized')) {
                    $('#suggestive-slider').slick('unslick');
                }
                $('#suggestive-slider').html('');

                //remove searching class
                $('body').toggleClass('searching');

                //create results
                $.each(titles, function (index, title) {
                    var image1 = (title.i !== undefined) ? title.i[0] : '';
                    var titleShort = title.title.trimToLength(40); //create short title
                    var ia = title.image.split('.');
                    var type = ia.pop();
                    ia.pop();
                    ia.push('_V1_UX133_CR0,0,133,200_AL_');
                    ia.push(type);
                    var image = ia.join('.');

                    //populate the slider 
                    if ($('#tv').is(':checked')) {
                        var html = '<div><div class="suggestion" style="background-image:url(' + image + ')" data-id="' + title.imdbId + '"><h4>' + titleShort + ' <i>' + title.years + '</i></h4><h5>' + title.rating + '</h5><a class="rex-it" href="#" data-title="' + titleShort + '" data-id="' + title.imdbId + '">Rex this!</a></div></div>';
                        $('#suggestive-slider').append(html);
                    } else {
                        if (title.years && (title.years.indexOf('Series') === -1)) {
                            var html = '<div><div class="suggestion" style="background-image:url(' + image + ')" data-id="' + title.imdbId + '"><h4>' + titleShort + ' <i>' + title.years + '</i></h4><h5>' + title.rating + '</h5><a class="rex-it" href="#" data-title="' + titleShort + '" data-id="' + title.imdbId + '">Rex this!</a></div></div>';
                            $('#suggestive-slider').append(html);
                        }
                    }
                });
                //initialise the slider
                $('#suggestive-slider').slick({
                    slidesToShow: 3,
                    slidesToScroll: 3,
                    speed: 1200,{#                    swipeToSlide: true,#}
                    prevArrow: '<a class="slider-control slick-prev transition"></a>',
                    nextArrow: '<a class="slider-control slick-next transition"></a>'
                });

                //rex it 
                $('.rex-it').click(function (e) {
                    $('.title-box').val($(this).data('title'));
                    getTitleData($(this).data('id')); //find recommendations
                    $('body').toggleClass('searching');
                });
            }

            //animate the slides in on creation
            $('#suggestive-slider').on('init', function () {
                var tl = new TimelineMax();
                var $slides = $('.slick-slide');
                tl.staggerFrom($('.slick-slide'), 1, {x: 1000}, 0.1);
            });

            //truncation function
            String.prototype.trimToLength = function (m) {
                return (this.length > m)
                        ? jQuery.trim(this).substring(0, m).split(" ").slice(0, -1).join(" ") + "..."
                        : this;
            };
    </script>

{% endblock postscripts %}
